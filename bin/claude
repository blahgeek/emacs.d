#!/usr/bin/env _bin-wrapper

function get_api_key(){
    local host="$1"
    local api_key="$(emacsclient-on-current-server -e "(gptel-api-key-from-auth-source \"$host\")")"
    # trim surrounding quote
    api_key="${api_key%\"}"
    api_key="${api_key#\"}"
    echo "$api_key"
}

if [ ! -f ~/.claude.json ]; then
    echo '{ "hasCompletedOnboarding": true }' > ~/.claude.json
fi

if [[ -n "$INSIDE_MSH_TEAM" ]]; then
    echo "Inside msh team, using Qianxun..."
    export ANTHROPIC_BASE_URL=https://openai.app.msh.team/raw/vibe/
    API_KEY="$(get_api_key api.msh.team)"
else
    API_KEY="$(get_api_key api.anthropic.com)"
fi

echo "Using api_key $API_KEY"
export ANTHROPIC_API_KEY="$API_KEY"

if [[ "$(uname)" == "Linux" && "$PWD" != "$HOME" ]]; then
    # with default profile
    prefix_args=(
        firejail
        --read-only="$HOME"
        --read-write="$HOME"/".claude*"
        --read-write="$PWD"
        --read-only="$PWD/.git"
        --read-only="$PWD/.jj"
    )
   echo "Sandboxing with ${prefix_args[@]}, YOLO!"

   extra_args=(
       --dangerously-skip-permissions
   )
fi

# Local Variables:
# mode: sh
# End:
