#!/usr/bin/env _bin-wrapper

function get_api_key(){
    local host="$1"
    local api_key="$(emacsclient-on-current-server -e "(gptel-api-key-from-auth-source \"$host\")")"
    # trim surrounding quote
    api_key="${api_key%\"}"
    api_key="${api_key#\"}"
    echo "$api_key"
}

if [ ! -f ~/.claude.json ]; then
    echo '{ "hasCompletedOnboarding": true }' > ~/.claude.json
fi

export OPENROUTER_API_KEY="$(get_api_key openrouter-claude-code)"
export ANTHROPIC_BASE_URL="https://openrouter.ai/api"
export ANTHROPIC_AUTH_TOKEN="$OPENROUTER_API_KEY"
export ANTHROPIC_API_KEY="" # Important: Must be explicitly empty
echo "Using OpenRouter with api_key $OPENROUTER_API_KEY"

sandbox_rw_files=("$HOME/.claude.json")
sandbox_extra_args=(--dangerously-skip-permissions)

script_dir="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
source "$script_dir/_bwrap-setup"

# Local Variables:
# mode: sh
# End:
