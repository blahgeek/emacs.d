#!/usr/bin/env _bin-wrapper

function get_api_key(){
    local host="$1"
    local api_key="$(emacsclient-on-current-server -e "(gptel-api-key-from-auth-source \"$host\")")"
    # trim surrounding quote
    api_key="${api_key%\"}"
    api_key="${api_key#\"}"
    echo "$api_key"
}

if [ ! -f ~/.claude.json ]; then
    echo '{ "hasCompletedOnboarding": true }' > ~/.claude.json
fi

if [[ -n "$INSIDE_MSH_TEAM" ]]; then
    echo "Inside msh team, using Qianxun..."
    export ANTHROPIC_BASE_URL=https://openai.app.msh.team/raw/vibe/
    API_KEY="$(get_api_key api.msh.team)"
else
    API_KEY="$(get_api_key api.anthropic.com)"
fi

echo "Using api_key $API_KEY"
export ANTHROPIC_API_KEY="$API_KEY"

sandbox_rw_files=("$HOME/.claude.json")
sandbox_extra_args=(--dangerously-skip-permissions)

script_dir="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
source "$script_dir/_bwrap-setup"

# Local Variables:
# mode: sh
# End:
