#!/bin/bash

function get_api_key(){
    local host="$1"
    local api_key="$(emacsclient-on-current-server -e "(gptel-api-key-from-auth-source \"$host\")")"
    # trim surrounding quote
    api_key="${api_key%\"}"
    api_key="${api_key#\"}"
    echo "$api_key"
}

# Get the directory containing this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ -n "$INSIDE_MSH_TEAM" ]; then
    echo "Using klaude"
    export MOONSHOT_STAFF_KEY="$(get_api_key api.msh.team)"
    exec klaude "$@"
fi

HOST="api.moonshot.cn"
API_KEY="$(get_api_key $HOST)"

echo "Using $HOST, api_key $API_KEY"

export ANTHROPIC_BASE_URL="https://$HOST/anthropic/"
export ANTHROPIC_API_KEY="$API_KEY"
# export ANTHROPIC_AUTH_TOKEN="$API_KEY"
export ANTHROPIC_MODEL=kimi-k2-turbo-preview
export ANTHROPIC_SMALL_FAST_MODEL=kimi-k2-turbo-preview

exec claude "$@"
